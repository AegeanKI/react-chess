(this["webpackJsonpreact-chess"]=this["webpackJsonpreact-chess"]||[]).push([[0],{76:function(e,t,n){},78:function(e,t,n){"use strict";n.r(t);var a=n(15),i=n(1),r=n(2),o=n(4),s=n(3),c=n(11),u=n.n(c),l=n(38),h=n.n(l),v=n(39),d=n.n(v),y=(n(76),n(40)),p=function(){function e(t,n){Object(i.a)(this,e),this.y=t,this.x=n}return Object(r.a)(e,[{key:"add",value:function(t){return new e(this.y+t.y,this.x+t.x)}},{key:"minus",value:function(t){return new e(this.y-t.y,this.x-t.x)}},{key:"equal",value:function(e){return null!==e&&this.y===e.y&&this.x===e.x}},{key:"mul",value:function(t){return new e(this.y*t,this.x*t)}},{key:"div",value:function(t){return new e(this.y/t,this.x/t)}},{key:"step",value:function(t,n){return new e(this.y+t,this.x+n)}},{key:"xDis",value:function(e){return Math.abs(this.x-e.x)}},{key:"yDis",value:function(e){return Math.abs(this.y-e.y)}},{key:"xEqual",value:function(e){return 0===this.xDis(e)}},{key:"yEqual",value:function(e){return 0===this.yDis(e)}}]),e}();function m(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];switch(e){case"pawn":return new b(t,n);case"queen":return new w(t,n);case"king":return new C(t,n);case"rock":return new P(t,n);case"bishop":return new k(t,n);case"knight":return new M(t,n);default:var a=e;return m(a.pieceType,a.pieceColor,a.alreadyMoved)}}var f=function(){function e(t){Object(i.a)(this,e),this.timestamp=t.timestamp?t.timestamp:1,t.squares?this.squares=t.squares.map((function(e){return e.map((function(e){return e?m(e.pieceType,e.pieceColor,e.alreadyMoved):null}))})):this.squares=t.map((function(e){return e.map((function(e){return e?e.copyPiece():null}))}))}return Object(r.a)(e,[{key:"valeuOf",value:function(){return this.timestamp}},{key:"copyBoard",value:function(){return new e(this)}},{key:"equal",value:function(e){for(var t=0;t<8;t++)for(var n=0;n<8;n++){var a=this.squares[t][n],i=e.squares[t][n];if(!(!a&&!i||a&&i&&a.equal(i)))return console.log("board is not equal at",t,n),console.log("thisPiece:",a),console.log("anotherPiece:",i),!1}return!0}},{key:"isValidCoord",value:function(e){return null!==e&&e.y>=0&&e.y<8&&e.x>=0&&e.x<8}},{key:"getPiece",value:function(e){return this.isValidCoord(e)?this.squares[e.y][e.x]:null}},{key:"getPieceCanMovePosition",value:function(e,t){if(this.isValidCoord(e)){var n=this.getPiece(e),a=n.getCanMovePositionInGeneralRule(e,this);return n.updateCanMovePositionInSpecialRule(e,this,a,t)}return[]}},{key:"hasPiece",value:function(e){return!!this.isValidCoord(e)&&null!==this.squares[e.y][e.x]}},{key:"hasNoPiece",value:function(e){return!!this.isValidCoord(e)&&null===this.squares[e.y][e.x]}},{key:"isSamePieceColor",value:function(e,t){return this.getPiece(e).pieceColor===this.getPiece(t).pieceColor}},{key:"isSamePieceType",value:function(e,t){return this.getPiece(e).pieceType===t}},{key:"canEatPiece",value:function(e,t){return this.isValidCoord(t)&&this.hasPiece(t)&&!this.isSamePieceColor(e,t)}},{key:"setPiece",value:function(e,t){this.isValidCoord(e)&&(this.squares[e.y][e.x]=t)}},{key:"removePiece",value:function(e){this.setPiece(e,null)}},{key:"isDoingEnPassant",value:function(e){return!!this.isValidCoord(e)&&(this.isSamePieceType(e,"pawn")&&(0===e.y||7===e.y))}},{key:"isUsingSpeicalRule",value:function(e,t){var n=this.isSamePieceType(e,"pawn")&&1===e.xDis(t)&&!this.hasPiece(t)?1:null,a=this.isSamePieceType(e,"king")&&2===e.xDis(t)?2:null;return n||a}},{key:"updateBoardByEnPassant",value:function(e,t){var n=this.copyBoard(),a=this.getPiece(e).pieceColor,i=0===t.yDis(e)?m("queen",a):1===t.yDis(e)?m("knight",a):2===t.yDis(e)?m("rock",a):3===t.yDis(e)?m("bishop",a):null;return n.setPiece(e,i),n}},{key:"updateSquaresUsingSpecialRule",value:function(e,t,n){var a=this.copyBoard();if(1===e)a.removePiece(new p(t.y,n.x));else if(2===e){var i=n.minus(t).div(2),r=i.x>0?new p(t.y,7):new p(t.y,0);a.setPiece(n.minus(i),this.getPiece(r)),a.removePiece(r)}return a}},{key:"updateBoardByMoving",value:function(e,t){var n=this.copyBoard(),a=this.isUsingSpeicalRule(e,t);return a&&(n=this.updateSquaresUsingSpecialRule(a,e,t)),n.setPiece(t,n.getPiece(e)),n.removePiece(e),n.getPiece(t).setAlreadyMoved(),n}},{key:"updateBoardByPiece",value:function(e,t){console.log("in updateBoardByPiece"),console.log("before update, timestamp =",this.timestamp);var n=null;return(n=this.isDoingEnPassant(e)?this.updateBoardByEnPassant(e,t):this.updateBoardByMoving(e,t)).addTimestamp(),console.log("after update, timestamp =",n.timestamp),n}},{key:"mayLoose",value:function(e,t){for(var n=this.updateBoardByPiece(e,t),a=null,i=0;i<8;i++)for(var r=0;r<8;r++){var o=new p(i,r);if(n.hasPiece(o)&&!n.isSamePieceColor(t,o))if(n.isSamePieceType(o,"king"))a=o;else if(n.getPieceCanMovePosition(o,{startPos:e,endPos:t,piece:n.getPiece(t)}).some((function(e){return e.equal(t)})))return!0}var s,c=n.getPiece(a).direction,u=Object(y.a)(c);try{for(u.s();!(s=u.n()).done;){var l=s.value;if(a.add(l).equal(t))return!0}}catch(h){u.e(h)}finally{u.f()}return!1}},{key:"addTimestamp",value:function(){this.timestamp+=1}}]),e}(),g=function(){function e(t,n){var a=arguments.length>2&&void 0!==arguments[2]&&arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:Math.max(8,8);Object(i.a)(this,e),this.pieceColor=t,this.pieceType=n,this.alreadyMoved=a,this.direction=r,this.maxMultiple=o}return Object(r.a)(e,[{key:"equal",value:function(e){return this.pieceColor===e.pieceColor&&this.pieceType===e.pieceType&&this.alreadyMoved===e.alreadyMoved}},{key:"getCanMovePositionInGeneralRule",value:function(e,t){var n=this,a=[];return this.direction.forEach((function(i){for(var r=1;r<=n.maxMultiple;r++){var o=e.add(i.mul(r));if(!t.isValidCoord(o))break;if(t.hasPiece(o)){t.canEatPiece(e,o)&&a.push(o);break}a.push(o)}})),a}},{key:"updateCanMovePositionInSpecialRule",value:function(e,t,n,a){return n}},{key:"getAlreadyMoved",value:function(){return this.alreadyMoved}},{key:"setAlreadyMoved",value:function(){this.alreadyMoved=!0}}]),e}(),b=function(e){Object(o.a)(n,e);var t=Object(s.a)(n);function n(e){var a=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return Object(i.a)(this,n),t.call(this,e,"pawn",a)}return Object(r.a)(n,[{key:"copyPiece",value:function(){return new n(this.pieceColor,this.alreadyMoved)}},{key:"getCanMovePositionInGeneralRule",value:function(e,t){var n="white"===this.pieceColor?6:1,a="white"===this.pieceColor?-1:1,i=e.step(a,0),r=e.step(2*a,0),o=[];return t.isValidCoord(i)&&!t.hasPiece(i)&&o.push(i),e.y!==n||t.hasPiece(i)||t.hasPiece(r)||o.push(r),o}},{key:"updateCanMovePositionInSpecialRule",value:function(e,t,n,a){var i="white"===this.pieceColor?-1:1,r=e.step(i,1),o=e.step(i,-1),s=n.slice();return t.canEatPiece(e,r)&&s.push(r),t.canEatPiece(e,o)&&s.push(o),a&&"pawn"===a.piece.pieceType&&2===a.startPos.yDis(a.endPos)&&1===a.startPos.xDis(e)&&0===a.endPos.yDis(e)&&s.push(new p(e.y+i,a.startPos.x)),s}}]),n}(g),P=function(e){Object(o.a)(n,e);var t=Object(s.a)(n);function n(e){var a=arguments.length>1&&void 0!==arguments[1]&&arguments[1];Object(i.a)(this,n);var r=[new p(1,0),new p(0,1),new p(-1,0),new p(0,-1)];return t.call(this,e,"rock",a,r)}return Object(r.a)(n,[{key:"copyPiece",value:function(){return new n(this.pieceColor,this.alreadyMoved)}}]),n}(g),k=function(e){Object(o.a)(n,e);var t=Object(s.a)(n);function n(e){var a=arguments.length>1&&void 0!==arguments[1]&&arguments[1];Object(i.a)(this,n);var r=[new p(1,1),new p(1,-1),new p(-1,1),new p(-1,-1)];return t.call(this,e,"bishop",a,r)}return Object(r.a)(n,[{key:"copyPiece",value:function(){return new n(this.pieceColor,this.alreadyMoved)}}]),n}(g),w=function(e){Object(o.a)(n,e);var t=Object(s.a)(n);function n(e){var a=arguments.length>1&&void 0!==arguments[1]&&arguments[1];Object(i.a)(this,n);var r=[new p(1,0),new p(0,1),new p(-1,0),new p(0,-1),new p(1,1),new p(1,-1),new p(-1,1),new p(-1,-1)];return t.call(this,e,"queen",a,r)}return Object(r.a)(n,[{key:"copyPiece",value:function(){return new n(this.pieceColor,this.alreadyMoved)}}]),n}(g),M=function(e){Object(o.a)(n,e);var t=Object(s.a)(n);function n(e){var a=arguments.length>1&&void 0!==arguments[1]&&arguments[1];Object(i.a)(this,n);var r=[new p(2,1),new p(-2,1),new p(2,-1),new p(-2,-1),new p(1,2),new p(1,-2),new p(-1,2),new p(-1,-2)];return t.call(this,e,"knight",a,r,1)}return Object(r.a)(n,[{key:"copyPiece",value:function(){return new n(this.pieceColor,this.alreadyMoved)}}]),n}(g),C=function(e){Object(o.a)(n,e);var t=Object(s.a)(n);function n(e){var a=arguments.length>1&&void 0!==arguments[1]&&arguments[1];Object(i.a)(this,n);var r=[new p(1,1),new p(-1,1),new p(1,-1),new p(-1,-1),new p(1,0),new p(0,-1),new p(-1,0),new p(0,1)];return t.call(this,e,"king",a,r,1)}return Object(r.a)(n,[{key:"copyPiece",value:function(){return new n(this.pieceColor,this.alreadyMoved)}},{key:"updateCanMovePositionInSpecialRule",value:function(e,t,n,a){if(n=n.filter((function(n){return!t.mayLoose(e,n)})),!t.getPiece(e).getAlreadyMoved()){var i=[new p(e.y,0),new p(e.y,7)],r=[new p(0,-1),new p(0,1)];i.forEach((function(i,o){if(t.hasPiece(i)&&t.isSamePieceType(i,"rock")&&!t.getPiece(i).getAlreadyMoved()){for(var s=e.add(r[o]);!i.equal(s);s=s.add(r[o]))if(t.hasPiece(s))return;if(t.mayLoose(e,e.add(r[o]),a)||t.mayLoose(e,e.add(r[o].mul(2)),a))return;n.push(e.add(r[o].mul(2)))}}))}return n}}]),n}(g),j=n(0);function O(e){var t="square "+e.squareBackgroundColor;return Object(j.jsxs)("button",{className:t,onClick:e.onClick,children:[e.pieceImgSrc?Object(j.jsx)("img",{src:e.pieceImgSrc,alt:e.pieceImgSrc}):null,e.stackImgSrc?Object(j.jsx)("img",{className:"stack-image",src:e.stackImgSrc,alt:e.stackImgSrc}):null,e.rowIndicatorValue?Object(j.jsx)("p",{className:"row-indicator",children:e.rowIndicatorValue}):null,e.colIndicatorValue?Object(j.jsx)("p",{className:"col-indicator",children:e.colIndicatorValue}):null]})}var S=function(e){Object(o.a)(n,e);var t=Object(s.a)(n);function n(){return Object(i.a)(this,n),t.apply(this,arguments)}return Object(r.a)(n,[{key:"renderSquare",value:function(e){var t=this,n=8*e.y+e.x,a=0===e.x?8-e.y:null,i=7===e.y?String.fromCharCode(97+e.x):null,r=this.props.doingEnPassantCoord,o=this.props.board.getPiece(e),s=this.props.board.getPiece(r),c=this.props.mayMovePosition.some((function(t){return t.equal(e)})),u=e.equal(r)?"orange-square":e.equal(this.props.tryToMove)?"yellow-square":(e.y+e.x)%2===0?"black-square":"white-square",l=r&&e.xEqual(r)&&e.yDis(r)<4?"light-mask":r&&!e.equal(r)?"dark-mask":null,h=c&&o&&o.pieceType?"/react-chess/circle.png":c?"/react-chess/dot.png":l?"/react-chess/"+l+".png":null,v="light-mask"===l&&0===e.yDis(r)?"/react-chess/"+s.pieceColor+"-queen.png":"light-mask"===l&&1===e.yDis(r)?"/react-chess/"+s.pieceColor+"-knight.png":"light-mask"===l&&2===e.yDis(r)?"/react-chess/"+s.pieceColor+"-rock.png":"light-mask"===l&&3===e.yDis(r)?"/react-chess/"+s.pieceColor+"-bishop.png":o?"/react-chess/"+o.pieceColor+"-"+o.pieceType+".png":null;return Object(j.jsx)(O,{rowIndicatorValue:a,colIndicatorValue:i,pieceImgSrc:v,stackImgSrc:h,squareBackgroundColor:u,mayMove:c,usingMask:l,onClick:function(){return t.props.onClick(e)}},n)}},{key:"render",value:function(){var e=this;return Object(j.jsx)("div",{className:"chess-board-container",children:Object(a.a)(Array(8)).map((function(t,n){return Object(j.jsx)("div",{className:"chess-board-row",children:Object(a.a)(Array(8)).map((function(t,a){return e.renderSquare(new p(n,a))}))},n)}))})}}]),n}(u.a.Component),x=function(e){Object(o.a)(n,e);var t=Object(s.a)(n);function n(e){var a;return Object(i.a)(this,n),(a=t.call(this,e)).state={board:new f(a.getInitBoard()),canMove:null,nextColor:"white",tryToMove:null,mayMovePosition:[],historyMove:[],doingEnPassantCoord:null},a}return Object(r.a)(n,[{key:"getInitBoard",value:function(){var e=Array(8).fill(0).map((function(e){return Array(8).fill(null)})),t="rock knight bishop queen king bishop knight rock".split(" ");return e[0]=t.map((function(e){return m(e,"black")})),e[1]=Object(a.a)(Array(8)).map((function(e){return m("pawn","black")})),e[6]=Object(a.a)(Array(8)).map((function(e){return m("pawn","white")})),e[7]=t.map((function(e){return m(e,"white")})),e}},{key:"handleDoingEnPassant",value:function(e){var t=this.state.doingEnPassantCoord;if(!(Math.abs(t.y-e.y)>=4||t.x!==e.x)){var n=this.state.board.updateBoardByPiece(t,e);this.setState({board:n,doingEnPassantCoord:null,tryToMove:null,mayMovePosition:[]});var a=this.state.historyMove.slice();this.sendBoardToServer(n,a[a.length-1])}}},{key:"handlePieceMoving",value:function(e){var t=this.state.historyMove.slice();console.log("while moving"),console.log("before update board, timestamp =",this.state.board.timestamp);var n=this.state.board.updateBoardByPiece(this.state.tryToMove,e);console.log("after update board, timestamp =",n.timestamp);var a={startPos:this.state.tryToMove,endPos:e,piece:n.getPiece(e)};t.push(a),this.setState({board:n,nextColor:"black"===this.state.nextColor?"white":"black",historyMove:t,tryToMove:null,mayMovePosition:[]}),n.isDoingEnPassant(e)?this.setState({doingEnPassantCoord:e}):this.sendBoardToServer(n,a)}},{key:"handlePieceTryToMove",value:function(e){var t=this.state.board,n=this.state.historyMove.slice(),a=t.getPieceCanMovePosition(e,n[n.length-1]);this.setState({tryToMove:e,mayMovePosition:a})}},{key:"handleOperationCancel",value:function(e){this.setState({tryToMove:null,mayMovePosition:[]})}},{key:"sendBoardToServer",value:function(e,t){var n=this.props.socket;if(n&&e){var a={board:e,lastMove:t};console.log("send to server",a),n.emit("sendToSameRoom",a)}}},{key:"handleClick",value:function(e){this.state.doingEnPassantCoord?this.handleDoingEnPassant(e):this.state.mayMovePosition.some((function(t){return t.equal(e)}))?this.handlePieceMoving(e):this.state.board.hasPiece(e)&&this.state.board.getPiece(e).pieceColor===this.state.nextColor&&this.state.nextColor===this.state.canMove?this.handlePieceTryToMove(e):this.handleOperationCancel(e)}},{key:"render",value:function(){var e=this;return console.log("re rendering, this.state.board.timestamp:",this.state.board.timestamp),Object(j.jsx)("div",{className:"chess-game-container",children:Object(j.jsx)(S,{board:this.state.board,onClick:function(t){return e.handleClick(t)},tryToMove:this.state.tryToMove,mayMovePosition:this.state.mayMovePosition,doingEnPassantCoord:this.state.doingEnPassantCoord})})}}],[{key:"getDerivedStateFromProps",value:function(e,t){var n=0===e.orderFromServer?"white":1===e.orderFromServer?"black":null;if(n!==t.canMove)return console.log("set canMove:",n),{canMove:n};if(e.boardFromServer&&e.boardFromServer.timestamp>t.board.timestamp&&t.nextColor!==n){console.log("set board:",e.boardFromServer);var a=t.historyMove.slice();return a.push(e.lastMoveFromServer),{board:e.boardFromServer,historyMove:a,nextColor:"black"===t.nextColor?"white":"black"}}return null}}]),n}(u.a.Component),q=function(e){Object(o.a)(n,e);var t=Object(s.a)(n);function n(e){var a;Object(i.a)(this,n),a=t.call(this,e);var r=d()("http://localhost:3000",{transports:["websocket","polling","flashsocket"]});return a.state={socket:r},a.listenMessage(r),a}return Object(r.a)(n,[{key:"listenMessage",value:function(e){var t=this;e&&(e.on("connect",(function(){console.log("success connect:",e.id)})),e.on("sendToSameRoom",(function(e){var n=e.board,a=e.lastMove;if(!(t.state.board&&n.timestamp<=t.state.board.timestamp)){console.log("set boardFromServer:",n);var i=new f(n),r=t.buildLastMoveFromJSON(a);t.setState({boardFromServer:i,lastMoveFromServer:r})}})),e.on("setUserOrderInRoom",(function(e){e!==t.state.orderFromServer&&(console.log("set orderFromServer:",e),t.setState({orderFromServer:e}))})))}},{key:"buildLastMoveFromJSON",value:function(e){var t=e;return t.piece=m(t.piece),t.endPos=new p(t.endPos.y,t.endPos.x),t.startPos=new p(t.startPos.y,t.startPos.x),t}},{key:"render",value:function(){return Object(j.jsx)("div",{className:"game-container",children:Object(j.jsx)(x,{socket:this.state.socket,orderFromServer:this.state.orderFromServer,boardFromServer:this.state.boardFromServer,lastMoveFromServer:this.state.lastMoveFromServer})})}}]),n}(u.a.Component);h.a.render(Object(j.jsx)(q,{}),document.getElementById("root"))}},[[78,1,2]]]);
//# sourceMappingURL=main.932a1788.chunk.js.map